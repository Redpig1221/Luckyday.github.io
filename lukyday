<!doctype html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Kanit', 'Sarabun', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      color: #4a5568;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #4299e1;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #3182ce;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #718096;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #4a5568;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      background: #38a169;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      background: #e53e3e;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      background: #dd6b20;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #4a5568;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: #4299e1;
    }

    .admin-menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .menu-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.3s ease;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .menu-item:hover {
      transform: translateY(-5px);
    }

    .menu-item h3 {
      margin: 0 0 10px 0;
      font-size: 20px;
    }

    .menu-item p {
      margin: 0;
      opacity: 0.9;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .table th,
    .table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .table th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
    }

    .table tr:hover {
      background: #f7fafc;
    }

    .wheel-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    .slot-machine {
      background: linear-gradient(145deg, #2d3748, #4a5568);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      text-align: center;
      margin: 20px 0;
      max-width: 500px;
      width: 100%;
    }

    .slot-display {
      background: #1a202c;
      border-radius: 15px;
      padding: 30px;
      margin: 20px 0;
      border: 3px solid #4299e1;
      min-height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #4299e1;
      font-weight: bold;
    }

    .prize-image {
      max-width: 100px;
      max-height: 100px;
      border-radius: 10px;
      margin: 10px;
    }

    .spinning {
      animation: spin 2s linear;
    }

    @keyframes spin {
      0% {
        transform: rotateY(0deg);
      }

      100% {
        transform: rotateY(1080deg);
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      max-height: 80%;
      overflow-y: auto;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      font-weight: 500;
    }

    .alert-success {
      background-color: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }

    .alert-error {
      background-color: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }

    .alert-info {
      background-color: #bee3f8;
      color: #2a4365;
      border: 1px solid #90cdf4;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4299e1;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #4299e1, #3182ce);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
    }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .search-box {
      margin-bottom: 20px;
    }

    .hidden {
      display: none !important;
    }

    .code-input-container {
      max-width: 400px;
      margin: 0 auto 30px;
      text-align: center;
    }

    .code-input {
      font-size: 24px;
      text-align: center;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 15px;
      border: 3px solid #4299e1;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      width: 100%;
      box-sizing: border-box;
    }

    .prize-result {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      border-radius: 15px;
      margin: 20px 0;
    }

    .prize-name {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast-success {
      background: #48bb78;
    }

    .toast-error {
      background: #f56565;
    }

    .toast-info {
      background: #4299e1;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .nav-buttons {
        justify-content: center;
      }

      .admin-menu {
        grid-template-columns: 1fr;
      }

      .slot-machine {
        padding: 20px;
      }

      .modal-content {
        margin: 10% auto;
        padding: 20px;
        width: 95%;
      }

      .logo {
        font-size: 24px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
      }
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
</head>

<body>
  <div class="container">
    <!-- Login Page -->
    <div id="loginPage">
      <div class="login-container">
        <div class="card">
          <h2 style="text-align: center; margin-bottom: 30px; color: #4a5568;" id="loginTitle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <div id="welcomeMessage" style="text-align: center; margin-bottom: 20px; color: #666; font-size: 16px;">
            ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ
          </div>
          <form id="loginForm">
            <div class="form-group"><label for="username" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="username" class="form-input" required>
            </div>
            <div class="form-group"><label for="password" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="password" class="form-input" required>
            </div><button type="submit" class="btn btn-primary" style="width: 100%;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          </form>
          <div id="loginAlert" class="alert alert-error hidden" style="margin-top: 15px;"></div>
        </div>
      </div>
    </div><!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden">
      <div class="header">
        <div class="logo" id="systemTitle">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ - Admin
        </div>
        <div class="nav-buttons"><button class="btn btn-secondary" onclick="showAdminMenu()">‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
          <button class="btn btn-danger" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div><!-- Admin Menu -->
      <div id="adminMenu">
        <div class="admin-menu">
          <div class="menu-item" onclick="showMemberManagement()">
            <h3>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏•‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
          </div>
          <div class="menu-item" onclick="showCodeManagement()">
            <h3>üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h3>
            <p>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</p>
          </div>
          <div class="menu-item" onclick="showPrizeManagement()">
            <h3>üéÅ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</p>
          </div>
          <div class="menu-item" onclick="showPrizeHistory()">
            <h3>üìä ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
            <p>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
          </div>
          <div class="menu-item" onclick="showReports()">
            <h3>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
            <p>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</p>
          </div>
        </div>
      </div><!-- Member Management -->
      <div id="memberManagement" class="hidden">
        <div class="card">
          <h3>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
          <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="showAddMemberModal()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <button class="btn btn-warning" onclick="exportMembers()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>
          <div class="search-box"><input type="text" id="memberSearch" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å..." onkeyup="searchMembers()">
          </div>
          <div class="table-container">
            <table class="table" id="membersTable">
              <thead>
                <tr>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</th>
                  <th>‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå</th>
                  <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                  <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div><!-- Code Management -->
      <div id="codeManagement" class="hidden">
        <div class="card">
          <h3>üé´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h3>
          <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="showGenerateCodeModal()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà</button>
            <button class="btn btn-warning" onclick="exportCodes()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="availableCodes">
                0
              </div>
              <div class="stat-label">
                ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="usedCodes">
                0
              </div>
              <div class="stat-label">
                ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
              </div>
            </div>
          </div>
          <div class="table-container">
            <table class="table" id="codesTable">
              <thead>
                <tr>
                  <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                  <th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                  <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div><!-- Prize Management -->
      <div id="prizeManagement" class="hidden">
        <div class="card">
          <h3>üéÅ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
          <div style="margin-bottom: 20px;">
            <button class="btn btn-success" onclick="showAddPrizeModal()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
          </div>
          <div class="table-container">
            <table class="table" id="prizesTable">
              <thead>
                <tr>
                  <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th>
                  <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                  <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div><!-- Prize History -->
      <div id="prizeHistory" class="hidden">
        <div class="card">
          <h3>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
          <div class="search-box"><input type="text" id="historySearch" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." onkeyup="searchHistory()">
          </div>
          <div class="table-container">
            <table class="table" id="historyTable">
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
                  <th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                  <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                  <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div><!-- Reports -->
      <div id="reports" class="hidden">
        <div class="card">
          <h3>üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalPlays">
                0
              </div>
              <div class="stat-label">
                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalPrizes">
                0
              </div>
              <div class="stat-label">
                ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏à‡∏Å
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalPlayers">
                0
              </div>
              <div class="stat-label">
                ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </div>
            </div>
          </div>
          <div class="table-container">
            <table class="table" id="reportsTable">
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
                  <th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                  <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div><!-- User Dashboard -->
    <div id="userDashboard" class="hidden">
      <div class="header">
        <div class="logo" id="userSystemTitle">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ
        </div>
        <div class="nav-buttons"><button class="btn btn-secondary" onclick="showWheelPage()">üé∞ ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠</button>
          <button class="btn btn-secondary" onclick="showUserHistory()">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô</button>
          <button class="btn btn-danger" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div><!-- Wheel Page -->
      <div id="wheelPage">
        <div class="wheel-container">
          <div class="code-input-container">
            <h3 style="color: white; margin-bottom: 20px;">üé´ ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h3><input type="text" id="codeInput" class="code-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå" maxlength="10">
            <br><br><button class="btn btn-primary" onclick="validateCode()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™</button>
          </div>
          <div id="slotMachine" class="slot-machine hidden">
            <h3 style="color: white; margin-bottom: 20px;">üé∞ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• üé∞</h3>
            <div id="slotDisplay" class="slot-display">
              <div>
                ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!
              </div>
            </div>
            <button id="spinButton" class="btn btn-warning" style="font-size: 20px; padding: 15px 30px;" onclick="spinWheel()"> üé≤ ‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠ üé≤ </button>
          </div>
          <div id="prizeResult" class="hidden"></div>
        </div>
      </div><!-- User History -->
      <div id="userHistory" class="hidden">
        <div class="card">
          <h3>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
          <div class="table-container">
            <table class="table" id="userHistoryTable">
              <thead>
                <tr>
                  <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  <th>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</th>
                  <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                  <th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                  <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div><!-- Modals -->
  <!-- Add Member Modal -->
  <div id="addMemberModal" class="modal">
    <div class="modal-content"><span class="close" onclick="closeModal('addMemberModal')">√ó</span>
      <h3 id="memberModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
      <form id="memberForm"><input type="hidden" id="memberEditId">
        <div class="form-group"><label for="memberUsername" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="memberUsername" class="form-input" required>
        </div>
        <div class="form-group"><label for="memberPassword" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input type="password" id="memberPassword" class="form-input" required>
        </div>
        <div class="form-group"><label for="memberRealName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label> <input type="text" id="memberRealName" class="form-input" required>
        </div>
        <div class="form-group"><label for="memberLineId" class="form-label">‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå</label> <input type="text" id="memberLineId" class="form-input">
        </div>
        <div class="form-group"><label for="memberPhone" class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label> <input type="tel" id="memberPhone" class="form-input">
        </div><button type="submit" class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('addMemberModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </form>
    </div>
  </div><!-- Generate Code Modal -->
  <div id="generateCodeModal" class="modal">
    <div class="modal-content"><span class="close" onclick="closeModal('generateCodeModal')">√ó</span>
      <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏´‡∏°‡πà</h3>
      <form id="generateCodeForm">
        <div class="form-group"><label for="codeQuantity" class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏´‡∏±‡∏™</label> <input type="number" id="codeQuantity" class="form-input" min="1" max="100" value="1" required>
        </div>
        <div class="form-group"><label for="codePrefix" class="form-label">Prefix (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label> <input type="text" id="codePrefix" class="form-input" maxlength="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ABC">
        </div><button type="submit" class="btn btn-success">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('generateCodeModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </form>
    </div>
  </div><!-- Add Prize Modal -->
  <div id="addPrizeModal" class="modal">
    <div class="modal-content"><span class="close" onclick="closeModal('addPrizeModal')">√ó</span>
      <h3 id="prizeModalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
      <form id="prizeForm"><input type="hidden" id="prizeEditId">
        <div class="form-group"><label for="prizeName" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label> <input type="text" id="prizeName" class="form-input" required>
        </div>
        <div class="form-group"><label for="prizeImage" class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</label> <input type="file" id="prizeImage" class="form-input" accept="image/*" onchange="handlePrizeImageChange(this)">
          <small style="color: #666; font-size: 12px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: JPG, PNG, GIF (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</small>
          <div id="currentPrizeImage" class="hidden" style="margin-top: 10px;"><img id="currentPrizeImagePreview" style="max-width: 100px; max-height: 100px; border-radius: 8px;">
          </div>
        </div>
        <div class="form-group"><label for="prizeQuantity" class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label> <input type="number" id="prizeQuantity" class="form-input" min="1" required>
        </div><button type="submit" class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal('addPrizeModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </form>
    </div>
  </div><!-- Loading Modal -->
  <div id="loadingModal" class="modal">
    <div class="modal-content" style="text-align: center; max-width: 300px;">
      <div class="loading">
        <div class="spinner"></div>
        <div id="loadingText">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...
        </div>
      </div>
    </div>
  </div>
  <script>
    // Configuration
        const CONFIG = {
            scriptUrl: 'https://script.google.com/macros/s/AKfycbwDvCmtGSmS3lrHe3wh4tQ9G3IAaJAZRDwITcDW7LEtrBA27lxKshF-CzJ0FQ_ftKq48w/exec',
            sheetId: '1DC4zEpojJ-93GuHNU8Sjx_1UNwryRU3CgylVJ566BVM',
            folderId: '1krWjih1ONyYHACoJ9mjpZJlej_q8iq4m'
        };

        // Default config for Element SDK
        const defaultConfig = {
            system_title: "‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ",
            admin_username: "admin",
            welcome_message: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡πÇ‡∏ä‡∏Ñ"
        };

        // Global variables
        let currentUser = null;
        let currentUserRole = null;
        let members = [];
        let codes = [];
        let prizes = [];
        let history = [];
        let currentCode = null;

        // Initialize Element SDK
        function initializeElementSDK() {
            try {
                if (window.elementSdk) {
                    window.elementSdk.init({
                        defaultConfig: defaultConfig,
                        onConfigChange: async (config) => {
                            try {
                                // Update system titles
                                const systemTitle = document.getElementById('systemTitle');
                                const userSystemTitle = document.getElementById('userSystemTitle');
                                const welcomeMessage = document.getElementById('welcomeMessage');
                                
                                if (systemTitle) {
                                    systemTitle.textContent = (config.system_title || defaultConfig.system_title) + ' - Admin';
                                }
                                if (userSystemTitle) {
                                    userSystemTitle.textContent = config.system_title || defaultConfig.system_title;
                                }
                                if (welcomeMessage) {
                                    welcomeMessage.textContent = config.welcome_message || defaultConfig.welcome_message;
                                }
                            } catch (error) {
                                console.log('Config change error:', error);
                            }
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ["system_title", config.system_title || defaultConfig.system_title],
                            ["admin_username", config.admin_username || defaultConfig.admin_username],
                            ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
                        ])
                    });
                }
            } catch (error) {
                console.log('Element SDK initialization error:', error);
            }
        }

        // Utility functions
        function showLoading(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingModal').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingModal').style.display = 'none';
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function generateCode(prefix = '') {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = prefix.toUpperCase();
            for (let i = 0; i < (8 - prefix.length); i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // API functions
        async function callAPI(action, data = {}) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                formData.append('sheetId', CONFIG.sheetId);
                formData.append('folderId', CONFIG.folderId);
                
                // Add all data to form
                Object.keys(data).forEach(key => {
                    if (data[key] !== undefined && data[key] !== null) {
                        formData.append(key, data[key]);
                    }
                });

                const response = await fetch(CONFIG.scriptUrl, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
                }
                return result.data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // File handling
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        function validateImage(file) {
            if (!file.type.startsWith('image/')) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return false;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB', 'error');
                return false;
            }
            
            return true;
        }

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                // Check admin login
                const adminUsername = window.elementSdk?.config?.admin_username || defaultConfig.admin_username;
                if (username === adminUsername && password === 'r48budtt') {
                    currentUser = { username: username, realName: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' };
                    currentUserRole = 'admin';
                    showAdminDashboard();
                    hideLoading();
                    return;
                }
                
                // Check member login
                try {
                    const membersData = await callAPI('getMembers');
                    members = membersData || [];
                    
                    const member = members.find(m => m.username === username && m.password === password);
                    
                    if (member) {
                        currentUser = member;
                        currentUserRole = 'user';
                        showUserDashboard();
                    } else {
                        document.getElementById('loginAlert').textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                        document.getElementById('loginAlert').classList.remove('hidden');
                    }
                } catch (apiError) {
                    // If API fails, check against sample data
                    const sampleMembers = [
                        { id: '1', username: 'user1', password: 'pass1', realName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö', lineId: 'test1', phone: '0812345678' },
                        { id: '2', username: 'user2', password: 'pass2', realName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', lineId: 'test2', phone: '0823456789' }
                    ];
                    
                    const member = sampleMembers.find(m => m.username === username && m.password === password);
                    
                    if (member) {
                        currentUser = member;
                        currentUserRole = 'user';
                        members = sampleMembers;
                        showUserDashboard();
                    } else {
                        document.getElementById('loginAlert').textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                        document.getElementById('loginAlert').classList.remove('hidden');
                    }
                }
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message, 'error');
            }
            
            hideLoading();
        });

        function logout() {
  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏≤‡∏Å '_blank' ‡πÄ‡∏õ‡πá‡∏ô '_top' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô "‡∏ó‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏¥‡∏°"
  window.open('https://script.google.com/macros/s/AKfycbyopKMF30DamYbORzki9tnW6b9KAYfhNv3Nwh2kABg_JglAgyCJK3clazsr4rNCLhfhJQ/exec', '_top', 'noopener,noreferrer');
  
  // (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ)
  // Also reset local state
  currentUser = null;
  currentUserRole = null;
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('adminDashboard').classList.add('hidden');
  document.getElementById('userDashboard').classList.add('hidden');
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  document.getElementById('loginAlert').classList.add('hidden');
}

        // Admin functions
        function showAdminDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminDashboard').classList.remove('hidden');
            showAdminMenu();
            loadAllData();
        }

        function showAdminMenu() {
            // Hide all admin sections
            document.getElementById('memberManagement').classList.add('hidden');
            document.getElementById('codeManagement').classList.add('hidden');
            document.getElementById('prizeManagement').classList.add('hidden');
            document.getElementById('prizeHistory').classList.add('hidden');
            document.getElementById('reports').classList.add('hidden');
            
            // Show admin menu
            document.getElementById('adminMenu').classList.remove('hidden');
        }

        async function loadAllData() {
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                // Try to load from API
                try {
                    const [membersData, codesData, prizesData, historyData] = await Promise.all([
                        callAPI('getMembers'),
                        callAPI('getCodes'),
                        callAPI('getPrizes'),
                        callAPI('getHistory')
                    ]);
                    
                    members = membersData || [];
                    codes = codesData || [];
                    prizes = prizesData || [];
                    history = historyData || [];
                } catch (apiError) {
                    console.log('API failed, using sample data:', apiError);
                    
                    // Use sample data if API fails
                    members = [
                        { id: '1', username: 'user1', password: 'pass1', realName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö', lineId: 'test1', phone: '0812345678' },
                        { id: '2', username: 'user2', password: 'pass2', realName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', lineId: 'test2', phone: '0823456789' }
                    ];
                    
                    codes = [
                        { id: '1', code: 'ABC123', status: 'unused', createdAt: new Date().toISOString(), usedBy: null },
                        { id: '2', code: 'DEF456', status: 'unused', createdAt: new Date().toISOString(), usedBy: null },
                        { id: '3', code: 'GHI789', status: 'used', createdAt: new Date().toISOString(), usedBy: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö' }
                    ];
                    
                    prizes = [
                        { id: '1', name: 'iPhone 15 Pro', initialQuantity: 5, remainingQuantity: 3, imageUrl: null },
                        { id: '2', name: 'iPad Air', initialQuantity: 10, remainingQuantity: 8, imageUrl: null },
                        { id: '3', name: 'AirPods Pro', initialQuantity: 20, remainingQuantity: 15, imageUrl: null }
                    ];
                    
                    history = [
                        {
                            id: '1',
                            code: 'GHI789',
                            playerName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö',
                            prizeName: 'iPhone 15 Pro',
                            imageUrl: null,
                            playedAt: new Date(Date.now() - 86400000).toISOString()
                        }
                    ];
                }
                
                updateAllTables();
                updateStats();
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        // Member Management
        function showMemberManagement() {
            document.getElementById('adminMenu').classList.add('hidden');
            document.getElementById('memberManagement').classList.remove('hidden');
            updateMembersTable();
        }

        function updateMembersTable() {
            const tbody = document.querySelector('#membersTable tbody');
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${member.username}</td>
                    <td>${member.realName}</td>
                    <td>${member.lineId || '-'}</td>
                    <td>${member.phone || '-'}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editMember('${member.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn btn-danger" onclick="deleteMember('${member.id}')">‡∏•‡∏ö</button>
                    </td>
                `;
            });
        }

        function showAddMemberModal() {
            document.getElementById('memberModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            document.getElementById('memberEditId').value = '';
            document.getElementById('memberForm').reset();
            document.getElementById('addMemberModal').style.display = 'block';
        }

        function editMember(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                document.getElementById('memberModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                document.getElementById('memberEditId').value = id;
                document.getElementById('memberUsername').value = member.username;
                document.getElementById('memberPassword').value = member.password;
                document.getElementById('memberRealName').value = member.realName;
                document.getElementById('memberLineId').value = member.lineId || '';
                document.getElementById('memberPhone').value = member.phone || '';
                document.getElementById('addMemberModal').style.display = 'block';
            }
        }

        async function deleteMember(id) {
            const confirmDelete = await showConfirmDialog('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmDelete) return;
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...');
                
                try {
                    await callAPI('deleteMember', { id });
                } catch (apiError) {
                    console.log('API delete failed, continuing with local delete');
                }
                
                members = members.filter(m => m.id !== id);
                updateMembersTable();
                showToast('‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        document.getElementById('memberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('memberEditId').value,
                username: document.getElementById('memberUsername').value,
                password: document.getElementById('memberPassword').value,
                realName: document.getElementById('memberRealName').value,
                lineId: document.getElementById('memberLineId').value,
                phone: document.getElementById('memberPhone').value
            };
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                if (formData.id) {
                    // Update existing member
                    try {
                        await callAPI('updateMember', formData);
                    } catch (apiError) {
                        console.log('API update failed, continuing with local update');
                    }
                    
                    const index = members.findIndex(m => m.id === formData.id);
                    if (index !== -1) {
                        members[index] = { ...members[index], ...formData };
                    }
                    showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    // Add new member
                    const newMember = { ...formData, id: generateId() };
                    
                    try {
                        const apiResult = await callAPI('addMember', formData);
                        newMember.id = apiResult.id || newMember.id;
                    } catch (apiError) {
                        console.log('API add failed, continuing with local add');
                    }
                    
                    members.push(newMember);
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
                
                updateMembersTable();
                closeModal('addMemberModal');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            }
            
            hideLoading();
        });

        function searchMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#membersTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function exportMembers() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ,‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á,‡πÑ‡∏≠‡∏î‡∏µ‡πÑ‡∏•‡∏ô‡πå,‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£\n"
                + members.map(m => `${m.username},${m.realName},${m.lineId || ''},${m.phone || ''}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'members.csv');
            link.click();
            
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // Code Management
        function showCodeManagement() {
            document.getElementById('adminMenu').classList.add('hidden');
            document.getElementById('codeManagement').classList.remove('hidden');
            updateCodesTable();
            updateCodeStats();
        }

        function updateCodesTable() {
            const tbody = document.querySelector('#codesTable tbody');
            tbody.innerHTML = '';
            
            const sortedCodes = [...codes].sort((a, b) => {
                if (a.status === 'unused' && b.status !== 'unused') return -1;
                if (a.status !== 'unused' && b.status === 'unused') return 1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            sortedCodes.forEach(code => {
                const row = tbody.insertRow();
                const statusText = code.status === 'unused' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ' : '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß';
                const statusClass = code.status === 'unused' ? 'success' : 'secondary';
                
                row.innerHTML = `
                    <td>${code.code}</td>
                    <td><span class="btn btn-${statusClass}" style="font-size: 12px; padding: 4px 8px;">${statusText}</span></td>
                    <td>${new Date(code.createdAt).toLocaleDateString('th-TH')}</td>
                    <td>${code.usedBy || '-'}</td>
                    <td>
                        ${code.status === 'unused' ? `
                            <button class="btn btn-danger" onclick="deleteCode('${code.id}')">‡∏•‡∏ö</button>
                            <button class="btn btn-secondary" onclick="copyCode('${code.code}')">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                        ` : ''}
                    </td>
                `;
            });
        }

        function updateCodeStats() {
            const available = codes.filter(c => c.status === 'unused').length;
            const used = codes.filter(c => c.status === 'used').length;
            
            document.getElementById('availableCodes').textContent = available;
            document.getElementById('usedCodes').textContent = used;
        }

        function showGenerateCodeModal() {
            document.getElementById('generateCodeModal').style.display = 'block';
        }

        document.getElementById('generateCodeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const quantity = parseInt(document.getElementById('codeQuantity').value);
            const prefix = document.getElementById('codePrefix').value;
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™...');
                
                const newCodes = [];
                for (let i = 0; i < quantity; i++) {
                    const newCode = {
                        id: generateId(),
                        code: generateCode(prefix),
                        status: 'unused',
                        createdAt: new Date().toISOString(),
                        usedBy: null
                    };
                    newCodes.push(newCode);
                }
                
                try {
                    await callAPI('generateCodes', { codes: JSON.stringify(newCodes) });
                } catch (apiError) {
                    console.log('API generate failed, continuing with local generation');
                }
                
                codes.push(...newCodes);
                
                updateCodesTable();
                updateCodeStats();
                closeModal('generateCodeModal');
                showToast(`‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${quantity} ‡∏£‡∏´‡∏±‡∏™`, 'success');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™: ' + error.message, 'error');
            }
            
            hideLoading();
        });

        function copyCode(code) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + code, 'success');
                }).catch(() => {
                    fallbackCopyTextToClipboard(code);
                });
            } else {
                fallbackCopyTextToClipboard(code);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + text, 'success');
                } else {
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏£‡∏´‡∏±‡∏™: ' + text, 'info');
                }
            } catch (err) {
                showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏£‡∏´‡∏±‡∏™: ' + text, 'info');
            }
            
            document.body.removeChild(textArea);
        }

        async function deleteCode(id) {
            const confirmDelete = await showConfirmDialog('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmDelete) return;
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™...');
                
                try {
                    await callAPI('deleteCode', { id });
                } catch (apiError) {
                    console.log('API delete failed, continuing with local delete');
                }
                
                codes = codes.filter(c => c.id !== id);
                updateCodesTable();
                updateCodeStats();
                showToast('‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        function exportCodes() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á,‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ\n"
                + codes.map(c => `${c.code},${c.status === 'unused' ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ' : '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß'},${new Date(c.createdAt).toLocaleDateString('th-TH')},${c.usedBy || ''}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'codes.csv');
            link.click();
            
            showToast('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }

        // Prize Management
        function showPrizeManagement() {
            document.getElementById('adminMenu').classList.add('hidden');
            document.getElementById('prizeManagement').classList.remove('hidden');
            updatePrizesTable();
        }

        function updatePrizesTable() {
            const tbody = document.querySelector('#prizesTable tbody');
            tbody.innerHTML = '';
            
            prizes.forEach(prize => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>
                        ${prize.imageUrl ? `<img src="${prize.imageUrl}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${prize.name}"><div style="width: 100px; height: 100px; background: #f0f0f0; display: none; align-items: center; justify-content: center; border-radius: 8px; color: #666; font-size: 12px;">‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>` : '<div style="width: 100px; height: 100px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #666; font-size: 12px;">üéÅ</div>'}
                    </td>
                    <td>${prize.name}</td>
                    <td>${prize.initialQuantity}</td>
                    <td>${prize.remainingQuantity}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editPrize('${prize.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="btn btn-danger" onclick="deletePrize('${prize.id}')">‡∏•‡∏ö</button>
                    </td>
                `;
            });
        }

        function showAddPrizeModal() {
            document.getElementById('prizeModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
            document.getElementById('prizeEditId').value = '';
            document.getElementById('prizeForm').reset();
            document.getElementById('currentPrizeImage').classList.add('hidden');
            document.getElementById('addPrizeModal').style.display = 'block';
        }

        function editPrize(id) {
            const prize = prizes.find(p => p.id === id);
            if (prize) {
                document.getElementById('prizeModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•';
                document.getElementById('prizeEditId').value = id;
                document.getElementById('prizeName').value = prize.name;
                document.getElementById('prizeQuantity').value = prize.initialQuantity;
                
                if (prize.imageUrl) {
                    document.getElementById('currentPrizeImagePreview').src = prize.imageUrl;
                    document.getElementById('currentPrizeImage').classList.remove('hidden');
                }
                
                document.getElementById('addPrizeModal').style.display = 'block';
            }
        }

        async function deletePrize(id) {
            const confirmDelete = await showConfirmDialog('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');
            if (!confirmDelete) return;
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...');
                
                try {
                    await callAPI('deletePrize', { id });
                } catch (apiError) {
                    console.log('API delete failed, continuing with local delete');
                }
                
                prizes = prizes.filter(p => p.id !== id);
                updatePrizesTable();
                showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        document.getElementById('prizeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('prizeEditId').value,
                name: document.getElementById('prizeName').value,
                initialQuantity: parseInt(document.getElementById('prizeQuantity').value)
            };
            
            const imageFile = document.getElementById('prizeImage').files[0];
            if (imageFile) {
                if (!validateImage(imageFile)) {
                    return;
                }
                formData.imageData = await fileToBase64(imageFile);
                formData.imageName = imageFile.name;
                formData.imageMimeType = imageFile.type;
            }
            
            try {
                showLoading(imageFile ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                if (formData.id) {
                    // Update existing prize
                    try {
                        const updatedPrize = await callAPI('updatePrize', formData);
                        const index = prizes.findIndex(p => p.id === formData.id);
                        if (index !== -1) {
                            prizes[index] = { ...prizes[index], ...updatedPrize };
                        }
                    } catch (apiError) {
                        console.log('API update failed, continuing with local update');
                        const index = prizes.findIndex(p => p.id === formData.id);
                        if (index !== -1) {
                            prizes[index] = { ...prizes[index], name: formData.name, initialQuantity: formData.initialQuantity };
                        }
                    }
                    showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                } else {
                    // Add new prize
                    const newPrize = { 
                        ...formData, 
                        id: generateId(),
                        remainingQuantity: formData.initialQuantity,
                        imageUrl: null
                    };
                    
                    try {
                        const apiResult = await callAPI('addPrize', formData);
                        newPrize.imageUrl = apiResult.imageUrl;
                        newPrize.id = apiResult.id || newPrize.id;
                    } catch (apiError) {
                        console.log('API add failed, continuing with local add');
                    }
                    
                    prizes.push(newPrize);
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
                
                updatePrizesTable();
                closeModal('addPrizeModal');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            }
            
            hideLoading();
        });

        // Prize History
        function showPrizeHistory() {
            document.getElementById('adminMenu').classList.add('hidden');
            document.getElementById('prizeHistory').classList.remove('hidden');
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            
            const sortedHistory = [...history].sort((a, b) => new Date(b.playedAt) - new Date(a.playedAt));
            
            sortedHistory.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(record.playedAt).toLocaleDateString('th-TH')}</td>
                    <td>${record.playerName}</td>
                    <td>${record.prizeName}</td>
                    <td>
                        ${record.imageUrl ? `<img src="${record.imageUrl}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${record.prizeName}"><div style="width: 80px; height: 80px; background: #f0f0f0; display: none; align-items: center; justify-content: center; border-radius: 8px; color: #666; font-size: 12px;">‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>` : '<div style="width: 80px; height: 80px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #666; font-size: 12px;">üéÅ</div>'}
                    </td>
                    <td>${record.code}</td>
                `;
            });
        }

        function searchHistory() {
            const searchTerm = document.getElementById('historySearch').value.toLowerCase();
            const rows = document.querySelectorAll('#historyTable tbody tr');
            
            rows.forEach(row => {
                const playerName = row.cells[1].textContent.toLowerCase();
                row.style.display = playerName.includes(searchTerm) ? '' : 'none';
            });
        }

        // Reports
        function showReports() {
            document.getElementById('adminMenu').classList.add('hidden');
            document.getElementById('reports').classList.remove('hidden');
            updateReportsTable();
            updateReportStats();
        }

        function updateReportStats() {
            const totalPlays = history.length;
            const totalPrizes = history.length;
            const uniquePlayers = new Set(history.map(h => h.playerName)).size;
            
            document.getElementById('totalPlays').textContent = totalPlays;
            document.getElementById('totalPrizes').textContent = totalPrizes;
            document.getElementById('totalPlayers').textContent = uniquePlayers;
        }

        function updateReportsTable() {
            const tbody = document.querySelector('#reportsTable tbody');
            tbody.innerHTML = '';
            
            const sortedHistory = [...history].sort((a, b) => new Date(b.playedAt) - new Date(a.playedAt));
            
            sortedHistory.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(record.playedAt).toLocaleDateString('th-TH')}</td>
                    <td>${record.playerName}</td>
                    <td>${record.prizeName}</td>
                    <td>${record.code}</td>
                `;
            });
        }

        function updateStats() {
            updateCodeStats();
            updateReportStats();
        }

        function updateAllTables() {
            updateMembersTable();
            updateCodesTable();
            updatePrizesTable();
            updateHistoryTable();
            updateReportsTable();
        }

        // User functions
        function showUserDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            showWheelPage();
            loadUserData();
        }

        async function loadUserData() {
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                
                // Load latest data from API
                try {
                    const [codesData, prizesData, historyData] = await Promise.all([
                        callAPI('getCodes'),
                        callAPI('getPrizes'),
                        callAPI('getHistory')
                    ]);
                    
                    codes = codesData || codes;
                    prizes = prizesData || prizes;
                    history = historyData || history;
                    
                    console.log('Loaded user data - History:', history);
                    
                } catch (apiError) {
                    console.log('API failed, using local data');
                }
                
                // Update user history table
                updateUserHistoryTable();
                
            } catch (error) {
                console.error('Load user data error:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        function showWheelPage() {
            document.getElementById('userHistory').classList.add('hidden');
            document.getElementById('wheelPage').classList.remove('hidden');
            resetWheelState();
        }

        function resetWheelState() {
            document.getElementById('codeInput').value = '';
            document.getElementById('slotMachine').classList.add('hidden');
            document.getElementById('prizeResult').classList.add('hidden');
            document.getElementById('spinButton').disabled = false;
            currentCode = null;
            
            const slotDisplay = document.getElementById('slotDisplay');
            slotDisplay.classList.remove('spinning');
            slotDisplay.innerHTML = '<div>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!</div>';
        }

        function showUserHistory() {
            document.getElementById('wheelPage').classList.add('hidden');
            document.getElementById('userHistory').classList.remove('hidden');
            loadUserHistoryFromAPI();
        }

        async function loadUserHistoryFromAPI() {
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô...');
                
                // Load latest history from API
                try {
                    const historyData = await callAPI('getHistory');
                    history = historyData || history;
                } catch (apiError) {
                    console.log('API failed, using local history');
                }
                
                updateUserHistoryTable();
                
            } catch (error) {
                console.error('Load history error:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        function updateUserHistoryTable() {
            const tbody = document.querySelector('#userHistoryTable tbody');
            tbody.innerHTML = '';
            
            if (!currentUser) {
                console.log('No current user found');
                return;
            }
            
            console.log('Current user:', currentUser.realName);
            console.log('All history:', history);
            
            const userHistory = history
                .filter(h => {
                    console.log('Checking history record:', h.playerName, 'vs', currentUser.realName);
                    return h.playerName === currentUser.realName || h.playerName === currentUser.username;
                })
                .sort((a, b) => new Date(b.playedAt) - new Date(a.playedAt));
            
            console.log('Filtered user history:', userHistory);
            
            if (userHistory.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="5" style="text-align: center; color: #666; padding: 40px;">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô<br>
                        <small>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</small>
                    </td>
                `;
                return;
            }
            
            userHistory.forEach(record => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(record.playedAt).toLocaleDateString('th-TH')}</td>
                    <td>${record.prizeName}</td>
                    <td>
                        ${record.imageUrl ? `<img src="${record.imageUrl}" class="prize-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${record.prizeName}"><div style="width: 80px; height: 80px; background: #f0f0f0; display: none; align-items: center; justify-content: center; border-radius: 8px; color: #666; font-size: 12px;">‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>` : '<div style="width: 80px; height: 80px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border-radius: 8px; color: #666; font-size: 12px;">üéÅ</div>'}
                    </td>
                    <td>${record.code}</td>
                    <td>
                        <button class="btn btn-success" onclick="downloadPrizeImage('${record.prizeName}', '${record.imageUrl || ''}', '${record.code}', '${record.playedAt}')">
                            ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û
                        </button>
                    </td>
                `;
            });
        }

        async function validateCode() {
            const codeInput = document.getElementById('codeInput').value.trim().toUpperCase();
            
            if (!codeInput) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', 'error');
                return;
            }
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™...');
                
                // Reload codes to get latest status
                try {
                    const codesData = await callAPI('getCodes');
                    codes = codesData || codes;
                } catch (apiError) {
                    console.log('API failed, using local codes');
                }
                
                const code = codes.find(c => {
                    const codeStr = c.code ? c.code.toString().trim().toUpperCase() : '';
                    const inputStr = codeInput.toString().trim().toUpperCase();
                    return codeStr === inputStr;
                });
                
                if (!code) {
                    showToast(`‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå "${codeInput}" ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`, 'error');
                    hideLoading();
                    return;
                }
                
                if (code.status === 'used') {
                    showToast('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'error');
                    hideLoading();
                    return;
                }
                
                currentCode = code;
                document.getElementById('slotMachine').classList.remove('hidden');
                showToast('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠‡πÑ‡∏î‡πâ', 'success');
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™: ' + error.message, 'error');
            }
            
            hideLoading();
        }

        async function spinWheel() {
            if (!currentCode) {
                showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠...');
                
                // Reload prizes to get latest quantities
                try {
                    const prizesData = await callAPI('getPrizes');
                    prizes = prizesData || prizes;
                } catch (apiError) {
                    console.log('API failed, using local prizes');
                }
                
                const availablePrizes = prizes.filter(p => p.remainingQuantity > 0);
                
                if (availablePrizes.length === 0) {
                    showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', 'error');
                    hideLoading();
                    return;
                }
                
                // Weighted random selection
                const totalWeight = availablePrizes.reduce((sum, prize) => sum + prize.remainingQuantity, 0);
                let random = Math.random() * totalWeight;
                let selectedPrize = null;
                
                for (const prize of availablePrizes) {
                    random -= prize.remainingQuantity;
                    if (random <= 0) {
                        selectedPrize = prize;
                        break;
                    }
                }
                
                if (!selectedPrize) {
                    selectedPrize = availablePrizes[0];
                }
                
                // Animate slot machine
                const slotDisplay = document.getElementById('slotDisplay');
                const spinButton = document.getElementById('spinButton');
                
                spinButton.disabled = true;
                slotDisplay.classList.add('spinning');
                slotDisplay.innerHTML = '<div>üé≤ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏°‡∏∏‡∏ô... üé≤</div>';
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                slotDisplay.classList.remove('spinning');
                
                // Record the win
                const historyRecord = {
                    id: generateId(),
                    code: currentCode.code,
                    playerName: currentUser.realName,
                    prizeName: selectedPrize.name,
                    imageUrl: selectedPrize.imageUrl,
                    playedAt: new Date().toISOString()
                };
                
                // Save to database
                try {
                    await callAPI('recordWin', {
                        ...historyRecord,
                        codeId: currentCode.id,
                        prizeId: selectedPrize.id
                    });
                } catch (apiError) {
                    console.log('API record failed, continuing with local record');
                }
                
                // Update local data
                currentCode.status = 'used';
                currentCode.usedBy = currentUser.realName;
                selectedPrize.remainingQuantity--;
                history.push(historyRecord);
                
                // Show result
                showPrizeResult(selectedPrize);
                
                showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ' + selectedPrize.name, 'success');
                
                // Auto download prize image
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...');
                await downloadPrizeImageAuto(selectedPrize.name, selectedPrize.imageUrl || '');
                
                setTimeout(() => {
                    hideLoading();
                    resetWheelState();
                    showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠', 'success');
                }, 1000);
                
            } catch (error) {
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏ß‡∏á‡∏•‡πâ‡∏≠: ' + error.message, 'error');
                document.getElementById('spinButton').disabled = false;
                hideLoading();
            }
        }

        function showPrizeResult(prize) {
            const resultDiv = document.getElementById('prizeResult');
            resultDiv.innerHTML = `
                <div class="prize-result">
                    <div class="prize-name">üéâ ${prize.name} üéâ</div>
                    ${prize.imageUrl ? `<img src="${prize.imageUrl}" class="prize-image" style="max-width: 200px; max-height: 200px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ${prize.name}"><div style="width: 200px; height: 150px; background: rgba(255,255,255,0.2); display: none; align-items: center; justify-content: center; border-radius: 10px; color: white; margin: 20px auto;">‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</div>` : '<div style="width: 200px; height: 150px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; border-radius: 10px; color: white; margin: 20px auto;">üéÅ ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• üéÅ</div>'}
                    <div style="margin-top: 20px;">
                        <div style="color: white; font-size: 18px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...</div>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            document.getElementById('slotMachine').classList.add('hidden');
        }

        async function downloadPrizeImageAuto(prizeName, imageUrl) {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 800;
                canvas.height = 600;
                
                // Background
                ctx.fillStyle = '#667eea';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! üéâ', canvas.width / 2, 100);
                
                // Prize name
                ctx.font = 'bold 36px Arial';
                ctx.fillText('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', canvas.width / 2, 180);
                ctx.fillText(prizeName, canvas.width / 2, 240);
                
                // Player info
                ctx.font = '24px Arial';
                ctx.fillText(`‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${currentUser.realName}`, canvas.width / 2, 320);
                ctx.fillText(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')}`, canvas.width / 2, 360);
                ctx.fillText(`‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${currentCode.code}`, canvas.width / 2, 400);
                
                // Prize image (if available)
                if (imageUrl) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        ctx.drawImage(img, canvas.width / 2 - 100, 450, 200, 100);
                        downloadCanvas(canvas, `prize_${prizeName}_${Date.now()}.png`);
                    };
                    img.onerror = () => {
                        downloadCanvas(canvas, `prize_${prizeName}_${Date.now()}.png`);
                    };
                    img.src = imageUrl;
                } else {
                    downloadCanvas(canvas, `prize_${prizeName}_${Date.now()}.png`);
                }
                
            } catch (error) {
                console.error('Error creating prize image:', error);
            }
        }

        async function downloadPrizeImage(prizeName, imageUrl, code, playedAt) {
            try {
                showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•...');
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 800;
                canvas.height = 600;
                
                // Background
                ctx.fillStyle = '#667eea';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Title
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! üéâ', canvas.width / 2, 100);
                
                // Prize name
                ctx.font = 'bold 36px Arial';
                ctx.fillText('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•', canvas.width / 2, 180);
                ctx.fillText(prizeName, canvas.width / 2, 240);
                
                // Player info
                ctx.font = '24px Arial';
                ctx.fillText(`‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${currentUser.realName}`, canvas.width / 2, 320);
                ctx.fillText(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(playedAt).toLocaleDateString('th-TH')}`, canvas.width / 2, 360);
                ctx.fillText(`‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${code}`, canvas.width / 2, 400);
                
                // Prize image (if available)
                if (imageUrl) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => {
                        ctx.drawImage(img, canvas.width / 2 - 100, 450, 200, 100);
                        downloadCanvas(canvas, `prize_${prizeName}_${new Date(playedAt).toLocaleDateString('th-TH')}.png`);
                        hideLoading();
                        showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    };
                    img.onerror = () => {
                        downloadCanvas(canvas, `prize_${prizeName}_${new Date(playedAt).toLocaleDateString('th-TH')}.png`);
                        hideLoading();
                        showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    };
                    img.src = imageUrl;
                } else {
                    downloadCanvas(canvas, `prize_${prizeName}_${new Date(playedAt).toLocaleDateString('th-TH')}.png`);
                    hideLoading();
                    showToast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                }
                
            } catch (error) {
                hideLoading();
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û: ' + error.message, 'error');
            }
        }

        function downloadCanvas(canvas, filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL();
            link.click();
        }

        // Handle prize image change
        function handlePrizeImageChange(input) {
            const file = input.files[0];
            if (file) {
                if (validateImage(file)) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('currentPrizeImagePreview').src = e.target.result;
                        document.getElementById('currentPrizeImage').classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    input.value = '';
                    document.getElementById('currentPrizeImage').classList.add('hidden');
                }
            } else {
                document.getElementById('currentPrizeImage').classList.add('hidden');
            }
        }

        // Confirmation dialog
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 400px; text-align: center;">
                        <h3 style="margin-bottom: 20px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                        <p style="margin-bottom: 30px;">${message}</p>
                        <button class="btn btn-danger confirm-btn" style="margin-right: 10px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button class="btn btn-secondary cancel-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('.confirm-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(true);
                });
                
                modal.querySelector('.cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    resolve(false);
                });
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                        resolve(false);
                    }
                });
            });
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            try {
                initializeElementSDK();
                
                // Show login page by default
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                document.getElementById('userDashboard').classList.add('hidden');
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loginPage').style.display = 'block';
            }
        });
  </script>
  <script>
    (function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'995eca39c32bf904',t:'MTc2MTcwMDE5Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();
  </script>
</body>

</html>
